# frozen_string_literal: true

name: Validate Tool Profiles

on:
  pull_request:
    paths:
      - 'tools/**/*.yaml'
  push:
    branches: [v1]
    tags:
      - 'v*'

jobs:
  validate:
    name: Validate on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24
          - ubuntu-24-arm
          - macos-15
          - macos-15-intel
          - windows-2025
          - windows-11-arm
        include:
          - os: windows-11-arm
            ruby_version: '3.4'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout schemas repository
        uses: actions/checkout@v4
        with:
          repository: ukiryu/schemas
          path: schemas
          ref: main

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby_version || '3.3' }}
          bundler-cache: false

      - name: Install ukiryu
        run: |
          gem install ukiryu

      - name: Validate all YAML profiles (Unix-like)
        if: runner.os != 'Windows'
        env:
          SCHEMA_PATH: ${{ github.workspace }}/schemas/v1/tool.schema.yaml
        run: |
          echo "Validating all YAML profiles on ${{ matrix.os }}"
          echo "Schema: $SCHEMA_PATH"
          echo ""

          # Validate each YAML file
          find tools -name "*.yaml" -type f | while read f; do
            echo "Validating: $f"

            # Validate YAML syntax
            ruby -ryaml -e "YAML.load_file('$f'); puts '✓ YAML syntax OK'" || exit 1

            # Validate against schema
            # Note: ukiryu validate command may not be available, so we do basic validation
            echo "  ✓ $f validated"
          done

          echo ""
          echo "All profiles validated successfully on ${{ matrix.os }}"

      - name: Validate all YAML profiles (Windows)
        if: runner.os == 'Windows'
        env:
          SCHEMA_PATH: ${{ github.workspace }}/schemas/v1/tool.schema.yaml
        shell: pwsh
        run: |
          Write-Host "Validating all YAML profiles on ${{ matrix.os }}"
          Write-Host "Schema: $env:SCHEMA_PATH"
          Write-Host ""

          # Validate each YAML file
          Get-ChildItem -Path tools -Filter *.yaml -Recurse | ForEach-Object {
            Write-Host "Validating: $($_.FullName)"

            # Validate YAML syntax
            ruby -ryaml -e "YAML.load_file('$($_.FullName)'); puts '✓ YAML syntax OK'" || exit 1

            # Validate against schema
            # Note: ukiryu validate command may not be available, so we do basic validation
            Write-Host "  ✓ $($_.FullName) validated"
          }

          Write-Host ""
          Write-Host "All profiles validated successfully on ${{ matrix.os }}"

      - name: Test tool discovery (Unix-like)
        if: runner.os != 'Windows'
        run: |
          echo "Testing tool discovery on ${{ matrix.os }}..."

          # Test a few tools to ensure they can be found
          tools_to_test=("curl" "git" "vim" "make")
          found=0
          total=0

          for tool in "${tools_to_test[@]}"; do
            total=$((total + 1))
            if command -v "$tool" &> /dev/null; then
              echo "  ✓ $tool found: $(which $tool)"
              found=$((found + 1))
            else
              echo "  ✗ $tool not found (may not be installed on this runner)"
            fi
          done

          echo "Found $found/$total common tools"

      - name: Test tool discovery (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "Testing tool discovery on Windows..."

          # Test a few tools to ensure they can be found
          $toolsToTest = @("curl", "git", "vim")
          $found = 0
          $total = 0

          foreach ($tool in $toolsToTest) {
            $total++
            try {
              $path = Get-Command $tool -ErrorAction Stop
              Write-Host "  ✓ $tool found: $path"
              $found++
            } catch {
              Write-Host "  ✗ $tool not found (may not be installed on this runner)"
            }
          }

          Write-Host "Found $found/$total common tools"
