# frozen_string_literal: true

name: Validate Tool Profiles

on:
  pull_request:
    paths:
      - 'tools/**/*.yaml'
  push:
    tags:
      - 'v*'

jobs:
  validate:
    name: Validate YAML profiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout schemas repository
        uses: actions/checkout@v4
        with:
          repository: ukiryu/schemas
          path: schemas
          ref: main

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Install ukiryu
        run: |
          gem install ukiryu

      - name: Get changed YAML files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            tools/**/*.yaml

      - name: Validate profiles
        if: steps.changed-files.outputs.any_changed
        env:
          SCHEMA_PATH: ${{ github.workspace }}/schemas/v1/tool.schema.yaml
        run: |
          echo "Validating against schema: $SCHEMA_PATH"
          echo ""

          # Validate each changed file
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Validating: $file"

            # Use ukiryu validate command
            if [ -f "$file" ]; then
              ukiryu validate --definition "$file" --schema "$SCHEMA_PATH"

              if [ $? -eq 0 ]; then
                echo "✓ $file is valid"
              else
                echo "✗ $file validation failed"
                exit 1
              fi
            else
              echo "⚠ $file was deleted (skipping validation)"
            fi
            echo ""
          done

      - name: Lint profiles
        if: steps.changed-files.outputs.any_changed
        run: |
          echo "Running linting checks..."
          echo ""

          # Lint each changed file
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Linting: $file"

            # Use ukiryu lint command
            if [ -f "$file" ]; then
              ukiryu lint file "$file"
            fi
            echo ""
          done
